# Next.jsÂ 14 P&L MVP â€” **Complete Project Skeleton**

Below is a **single copyâ€‘pasteable repo layout**.  All files are relative to the project root created with `create-next-app --app --ts --tailwind`.

```txt
pnl-matrix/
â”œâ”€ package.json
â”œâ”€ tsconfig.json
â”œâ”€ tailwind.config.js
â”œâ”€ postcss.config.js
â”œâ”€ next.config.mjs
â”œâ”€ .env.example              # (no real creds yet)
â”œâ”€ lib/
â”‚  â”œâ”€ mockData.ts            # despesa + nfe samples
â”‚  â””â”€ pnlLogic.ts            # aggregation + hierarchy helpers
â”œâ”€ app/
â”‚  â”œâ”€ layout.tsx             # RootLayout
â”‚  â”œâ”€ globals.css            # Tailwind base
â”‚  â”œâ”€ page.tsx               # redirect â†’ /pnl
â”‚  â””â”€ pnl/
â”‚     â”œâ”€ page.tsx            # SSR page
â”‚     â””â”€ YearSelect.tsx      # client component
â”œâ”€ app/api/
â”‚  â””â”€ pnl/
â”‚     â””â”€ route.ts            # mocked API
â””â”€ components/
   â””â”€ PnLTable.tsx           # TanStack Table UI
```

---
## 1Â package.json (add TanStack deps)
```jsonc
{
  "name": "pnl-matrix",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "14.1.3",
    "react": "^18",
    "react-dom": "^18",
    "@tanstack/react-table": "^8.19.3",
    "@tanstack/react-virtual": "^3.0.0",
    "clsx": "^2.0.0"
  },
  "devDependencies": {
    "autoprefixer": "^10.4.15",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.4",
    "typescript": "^5.4.0"
  }
}
```

> Run `npm install` or `pnpm i` after pasting.

---
## 2Â Tailwind / PostCSS / TSConfig (standard)
**tailwind.config.js**
```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}'
  ],
  theme: { extend: {} },
  plugins: []
};
```

**postcss.config.js**
```js
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
```

*(tsconfig.json is autoâ€‘generated by `create-next-app`; leave as is.)*

---
## 3Â Global styles
**app/globals.css**
```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

---
## 4Â Mock data
**lib/mockData.ts**
```ts
// â€”â€”â€” Sample Despesa â€”â€”â€”
export const despesa = [
  {
    dev_id: 839,
    codigo_lancamento_omie: 1831999009,
    valor_documento: 1201.94,
    data_entrada: '2025-01-16',
    Periodo: '2025-01',
    status_titulo: 'PAGO',
    codigo_categoria: '2.01.04',
    codigo_e_descricao: '2.01 + ImportaÃ§Ã£o',
    grupo_dre: '2.01.01',
    nome_projeto: 'kalena',
    categoria_descricao: 'Despachante',
    categoria_descricao_padrao: 'Compras de Mercadorias para Revenda',
    conta_despesa: 'S',
    fornecedor_nome: 'Satel Despachos Aduaneiros E Servicos Tecnicos Ltda',
    fornecedor_fantasia: 'Satel Despachos',
    cnpj_cpf: '64.659.055/0001-90',
    banco_descricao: 'ItaÃº SP',
    data_pagamento: '2025-01-23',
    valor_pago: 1201.94,
    conta_inativa: 'N'
  }
];

// â€”â€”â€” Sample NFE â€”â€”â€”
export const nfe = [
  {
    dev_id: '13',
    data_emissao: '2025-01-21',
    tipo_operacao: 'SaÃ­da',
    finalidade: 'Normal/Venda',
    cancelada: 'NÃ£o',
    nome_cenario: 'Venda',
    parsed_unit_cost: 0.0,
    parsed_quantity_units: 2.0,
    parsed_discount_value: 0,
    parsed_icmsst_value: 4.28,
    parsed_pis_value: 0.36,
    parsed_cofins_value: 1.68,
    parsed_iss_value: 0,
    parsed_ir_value: 0,
    parsed_icm_dest_value: 0,
    parsed_icm_remet_value: 0,
    parsed_icms_value: 10.08,
    parsed_ipi_value: 0,
    parsed_fcp_value: 0,
    parsed_fcpst_value: 0,
    parsed_total_product_value: 56.0,
    parsed_total_item_value: 60.28
  }
];
```

---
## 5Â Aggregation helpers
**lib/pnlLogic.ts** Â *(extremely simplified for the mock)*
```ts
import { nfe, despesa } from './mockData';

export type Month = `${number}-${'01'|'02'|'03'|'04'|'05'|'06'|'07'|'08'|'09'|'10'|'11'|'12'}`;
export type PnLNode = {
  id: string;
  parentId?: string;
  label: string;
  sign?: '+' | '-';
  values: Record<Month, number>; // month â†’ amount
};

// Utility: init months with 0
export const emptyYear = (year: number) =>
  Object.fromEntries(
    Array.from({ length: 12 }, (_, i) => [
      `${year}-${String(i + 1).padStart(2, '0')}` as Month,
      0
    ])
  ) as Record<Month, number>;

/** Build a minimal P&L tree for the selected year from mock data */
export function buildMockPnl(year: number): PnLNode[] {
  const grossRev: PnLNode = {
    id: '1',
    label: 'Receita Bruta / Gross Revenue',
    values: emptyYear(year)
  };
  const returns: PnLNode = {
    id: '2',
    label: 'DevoluÃ§Ãµes / Returns',
    sign: '-',
    values: emptyYear(year)
  };
  const netRev: PnLNode = {
    id: '6',
    parentId: 'rev',
    label: 'Receita LÃ­quida / Net Revenue',
    values: emptyYear(year)
  };

  //  ðŸš§  Very naive aggregation just to have numbers
  nfe.forEach((row) => {
    const month = row.data_emissao.slice(0, 7) as Month;
    if (month.startsWith(String(year))) {
      grossRev.values[month] += Number(row.parsed_total_item_value);
      // mock: no returns yet
    }
  });
  Object.keys(grossRev.values).forEach((m) => {
    netRev.values[m as Month] = grossRev.values[m as Month] - returns.values[m as Month];
  });

  return [
    { id: 'rev', label: 'Revenue', values: emptyYear(year) },
    grossRev,
    returns,
    netRev
  ];
}
```

---
## 6Â API Route (mock)
**app/api/pnl/route.ts**
```ts
import { buildMockPnl } from '@/lib/pnlLogic';
import { NextResponse } from 'next/server';

export async function GET(req: Request) {
  const { searchParams } = new URL(req.url);
  const year = Number(searchParams.get('year')) || new Date().getFullYear();
  const tree = buildMockPnl(year);
  return NextResponse.json(tree);
}
```

---
## 7Â Reusable PnLTable
**components/PnLTable.tsx**
```tsx
'use client';
import {
  ColumnDef,
  useReactTable,
  getCoreRowModel,
  getExpandedRowModel
} from '@tanstack/react-table';
import { useMemo, useState } from 'react';
import { PnLNode, Month } from '@/lib/pnlLogic';
import clsx from 'clsx';

const months: Month[] = [
  '2025-01','2025-02','2025-03','2025-04','2025-05','2025-06',
  '2025-07','2025-08','2025-09','2025-10','2025-11','2025-12'
] as Month[]; // will be rebuilt per year from parent

const fmt = (v: number) =>
  Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

export default function PnLTable({ data, year }: { data: PnLNode[]; year: number }) {
  const cols = useMemo<ColumnDef<PnLNode>[]>(() => {
    const monthCols: ColumnDef<PnLNode>[] = months.map((m) => ({
      id: m,
      header: m.slice(5),
      cell: ({ row }) => fmt(row.original.values[m] || 0),
      meta: { numeric: true }
    }));

    return [
      {
        id: 'expander',
        header: '',
        cell: ({ row }) =>
          row.getCanExpand() ? (
            <button {...{ onClick: row.getToggleExpandedHandler() }} className="mr-1">
              {row.getIsExpanded() ? 'â–¼' : 'â–¶'}
            </button>
          ) : null
      },
      {
        accessorKey: 'label',
        header: 'DescriÃ§Ã£o',
        cell: ({ row, getValue }) => (
          <span className="whitespace-nowrap" style={{ paddingLeft: row.depth * 16 }}>
            {getValue() as string}
          </span>
        )
      },
      ...monthCols
    ];
  }, [year]);

  const [expanded, setExpanded] = useState<Record<string, boolean>>({ rev: true });

  const table = useReactTable({
    data,
    columns: cols,
    state: { expanded },
    onExpandedChange: setExpanded,
    getSubRows: (row) => data.filter((r) => r.parentId === row.id),
    getCoreRowModel: getCoreRowModel(),
    getExpandedRowModel: getExpandedRowModel()
  });

  return (
    <div className="overflow-x-auto border rounded">
      <table className="w-full text-sm">
        <thead className="bg-gray-100">
          {table.getHeaderGroups().map((hg) => (
            <tr key={hg.id}>
              {hg.headers.map((h) => (
                <th
                  key={h.id}
                  className={clsx('px-2 py-1 text-left', h.column.columnDef.meta?.numeric && 'text-right')}
                >
                  {h.isPlaceholder ? null : h.renderHeader()}
                </th>
              ))}
            </tr>
          ))}
        </thead>
        <tbody>
          {table.getRowModel().rows.map((row) => (
            <tr key={row.id} className="border-b last:border-0">
              {row.getVisibleCells().map((cell) => (
                <td
                  key={cell.id}
                  className={clsx('px-2 py-1', cell.column.columnDef.meta?.numeric && 'text-right')}
                >
                  {cell.renderCell()}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

---
## 8Â Year select (client component)
**app/pnl/YearSelect.tsx**
```tsx
'use client';
import { useRouter, useSearchParams } from 'next/navigation';

export default function YearSelect() {
  const router = useRouter();
  const params = useSearchParams();
  const year = Number(params.get('year')) || new Date().getFullYear();

  const handle = (y: number) => {
    router.push(`/pnl?year=${y}`);
  };

  return (
    <div className="mb-4">
      <label className="mr-2 font-medium">Ano:</label>
      <select
        value={year}
        onChange={(e) => handle(Number(e.target.value))}
        className="border rounded px-2 py-1"
      >
        {Array.from({ length: 6 }, (_, i) => 2025 - i).map((y) => (
          <option key={y}>{y}</option>
        ))}
      </select>
    </div>
  );
}
```

---
## 9Â P&L Page (SSR + suspense)
**app/pnl/page.tsx**
```tsx
import PnLTable from '@/components/PnLTable';
import YearSelect from './YearSelect';

export const dynamic = 'force-dynamic';

export default async function PnlPage({ searchParams }: { searchParams: { year?: string } }) {
  const year = Number(searchParams.year) || new Date().getFullYear();
  const data = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL || ''}/api/pnl?year=${year}`, {
    cache: 'no-store'
  }).then((r) => r.json());

  return (
    <main className="p-6 space-y-4">
      <h1 className="text-2xl font-bold">P&amp;L â€“ {year}</h1>
      <YearSelect />
      <PnLTable data={data} year={year} />
    </main>
  );
}
```

---
## 10Â Root layout & redirect
**app/layout.tsx**
```tsx
import '@/app/globals.css';
import { ReactNode } from 'react';
export const metadata = { title: 'P&L Matrix' };
export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en">
      <body className="min-h-screen bg-gray-50 text-gray-900">{children}</body>
    </html>
  );
}
```

**app/page.tsx**
```tsx
import { redirect } from 'next/navigation';
export default function Home() {
  redirect('/pnl');
}
```

---
### ðŸš€Â Run the MVP
```bash
npm run dev   # or pnpm dev
```
Visit **http://localhost:3000/pnl** â†’ youâ€™ll see the year selector and a tiny mocked P&L tree (Revenue only).

From here you can:
1. Flesh out `pnlLogic.ts` with every line & formula.
2. Replace `mockData.ts` with real MySQL/BigQuery queries in `route.ts`.
3. Add virtualization (`@tanstack/react-virtual`) if Expense rows explode.

Thatâ€™s a fully compartmentalized project you can open in VSÂ Code and extend immediately.  Enjoy coding! ðŸŽ‰
